---
title: "Seal diet analysis"
author: "Vanessa Trijoulet"
output: bookdown::word_document2
#always_allow_html: true
bibliography: biblio.bib
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(readxl)

sps<-  matrix(c(
  "COD",	"Gadus morhua",	'cod',"Cod",
  "WHG",	"Merlangius merlangus", 'whiting',"Whiting",
  "HAD",	"Melanogrammus aeglefinus", "haddock","Haddock",
  "POK",	"Pollachius virens","saithe","Saithe",
  "MAC",	"Scomber scombrus","mackerel","Mackerel",
  "HER",	"Clupea harengus","herring","Herring",
  "SAN",	"Ammodytidae","sandeel",'N.sandeel',
  "NOP",	"Trisopterus esmarkii","norway pout","Nor.pout",
  "SPR",	"Sprattus sprattus","sprat",'Sprat',
  "PLE",  "Pleuronectes platessa","plaice","Plaice",
  "SOL",	"Solea solea","sole","Sole"),
  byrow=T,ncol=4)
colnames(sps)<-c('SMS','latin','species',"Species")
sps<-as.data.frame(sps)

## Diet files
datadir <-"data/"
files <- list.files(datadir)
files <- files[grep("Hg cons ", files)]

cons.q.area <- list()
for (fil in files){
## Extract total consumption per quarter
  ss<-read_xlsx(path=file.path(datadir, fil),sheet="cons") %>% rename(prey=species.name)
  ss
  cons.q.area[[fil]] <- by(ss,ss$quarter,function(x){
    a<-xtabs(cons.t~prey+region,data=x)
    round(cbind(a,rowSums(a)),2)
  }) # in tonnes
nameCons <- lapply(cons.q.area[[fil]], rownames)[[1]]
  # Change naming so same as SMS
  nameCons[which(nameCons %in% sps$Species)] <- sort(sps[which(sps$Species %in% nameCons),]$SMS)
  nameCons[which(nameCons=="Norway pout")] <- "NOP"
  nameCons[which(nameCons=="Sandeel")] <- "SAN"
  for (k in 1:length(cons.q.area[[fil]])) rownames(cons.q.area[[fil]][[k]])=nameCons
}
```


# Data available

Grey seal diet was made available for the years 1985, 2002, and 2010-2011 by the SMRU (Phil Hammond pers. comm.) for use in SMS.The way the seal diet data was obtained is described in detail in @hammond2016. 
The data included seal consumption per fish stock that are considered in SMS (`r paste(sps[which(sps$SMS %in% nameCons),"species"], collapse=", ")`) in tonnes per year, quarter (Q1-4), and regions of the North Sea (regions 1-4, Shetland, Orkney and northern North Sea, central North Sea, and southern North Sea respectively). The data also included  outputs from otolith experiments as estimated fish length in the diet given otolith size (per year, region, and quarter). 

These data allow us to allocate total consumption to length class of fish prey, the methods used are described below. 

# Method to allocate length distribution to grey seal consumption estimates

Each fish length sample is converted to weight using length-weight relationship parameters from @coull1989 (as also used in the previous keyruns). The fish weights (weighted by the total consumption per region and quarter) are summed across regions such that the weight consumed is given per species, length bin, quarter, and year. Weights are then converted to proportion consumed per length bin, and these proportions are multiplied by the total grey seal consumption (in weight) per species and quarter to obtained the weight of prey consumed per length bin. The biomass of other food eaten by grey seals is derived from the total grey seal consumption per quarter and year.
The output csv file ("adjusted_seal_diet.csv") contains the biomass of prey eaten by all grey seals (column "prey_w") per length bin, quarter, and year.
The number of scat samples per quarter and year is used to give information on uncertainty in the diet data, those are added to the column "n_food" in the output diet file.

Few assumptions were made while handling grey seal diet, as follows:  
- Sprat was added to other food because of the small total consumption in each year and the lack of length samples (was absent from the seal diet in the 2020 keyrun, so already considered other food).  
- If there are less than 5 length bins for a prey in one quarter and year, the length distribution from the adjacent quarter is added to these samples. This "borrowing" is made between quarters 1-2 and quarters 3-4. The 5 samples threshold was chosen after realizing that in few instances only 1-3 samples were available despite fish being consumed. We assume these are not representative of the real length distribution in the diet. The borrowing between quarter was chosen so that it might keep a distinction between spawning seasons, e.g, spring, autumn.  
- The diet in 1985 and 2010-2011 is given for a set of years e.g., 1983, 1985, 1988, and 2010-2011. In SMS we assume the diet is in the year where there is the largest number of samples, i.e, 1985, and 2010. 

The code  for the analysis is available on the [WGSAM GitHub repository](https://github.com/ices-eg/wg_WGSAM/blob/master/NorthSeaKeyRun_2023/Seal_diet/seal_2023.R). The script creates figures of the length distribution before and after borrowing.


# Method to split sandeel diet per area (northern or southern North Sea)

Sandeel in the North Sea area is managed as six individually assessed stocks. Given the lack of input data at the correct spatial scale, two sandeel stocks are considered in SMS and split into northern and southern North Sea stocks. In the previous SMS keyruns, the total grey seal predation was attributed entirely to the northern sandeel stock. In the 2023 keyrun, the proportion of sandeel consumed by grey seals was extracted from the diet data with the assumption that the northern areas correspond to Shetland, Orkney and northern North Sea, and the southern area to the central North Sea, and the southern North Sea. This resulted in the proportions in Table \@ref(tab:propSandeel). These proportions are used to split the diet data between northern and southern sandeel.

```{r propSandeel, echo=FALSE, warning=FALSE, message=FALSE}
# From consumption of sandeel
# Assumption North = Shetland, Orkney and northern North Sea, South = central North Sea, and southern North Sea
tmp <- lapply(cons.q.area, function(y) sapply(y, function(x) x["SAN", c("1","2","3","4")])) # row=region, col=quarter
tmp2 <- lapply(tmp, function(x) cbind("North" = apply(x[c("1","2"),],2,sum)/apply(x,2,sum), "South" = apply(x[c("3","4"),],2,sum)/apply(x,2,sum)))
propSandeel <-cbind(tmp2[[1]], tmp2[[2]], tmp2[[3]])
colnames(propSandeel) <- paste(c(rep("1985 ",2), rep("2002 ",2), rep("2010 ",2)), colnames(propSandeel))
rownames(propSandeel) <- paste("Quarter ", 1:4)

knitr::kable(propSandeel, digits=3, caption = "Proportion of sandeel consumed per area")
#x %>% add_header_above(c('1985'=2,'2002'=2,'2010'=2))
#x %>% as_image()
```



# References